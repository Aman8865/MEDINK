<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient Report</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdn.ckeditor.com/4.21.0/standard/ckeditor.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>

body {
    margin: 0;
    padding: 0;
    background: #1c1c1c; 
    font-family: Arial;
    height: 100vh;
    overflow: hidden;
}

/* ---------------- TOP BAR ---------------- */
.top-bar {
    width: 100%;
    background: #2f2f2f;
    padding: 8px 15px;
    color: white;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 20px;
    border-bottom: 2px solid #444;
    margin-top: 20px;
}

.top-item { font-weight: bold; }
.top-value { color: #00bfff; }

/* ---------------- MAIN LAYOUT ---------------- */
.main {
    display: flex;
    height: calc(100vh - 58px);
}

/* Left side image section */
.left-panel {
    width: 50%;
    background: black;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

#xrayImage {
    max-height: 100%;
    width: auto;
    display: block;
}

.fullscreen {
    position: fixed !important;
    top: 0;
    left: 0;
    width: 100vw !important;
    height: 100vh !important;
    background: black;
    z-index: 9999;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
}

.fullscreen img {
    width: 100% !important;
    height: 100% !important;
    object-fit: contain !important;
}


/* Bottom zoom bar */
.zoom-bar {
    position: absolute;
    bottom: 10px;
    display: flex;
    gap: 15px;
    background: rgba(0,0,0,0.5);
    padding: 10px 15px;
    border-radius: 8px;
}

.zoom-btn {
    color: white;
    font-size: 20px;
    cursor: pointer;
}

/* Right side report section */
.right-panel {
    width: 50%;
    background: #fefefe;
    padding: 20px;
    overflow-y: auto;
}

/* Buttons */
.btn-row {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
}

.btn-draft {
    background: #d6b375;
    padding: 12px 25px;
    border: none;
    border-radius: 6px;
    font-size: 15px;
    cursor: pointer;
}
.btn-submit {
    background: #28a745;
    color: white;
    padding: 12px 25px;
    border: none;
    border-radius: 6px;
    font-size: 15px;
    cursor: pointer;
}

/* ----------------- MOBILE RESPONSIVE ----------------- */
@media (max-width: 900px) {

    body {
        overflow: hidden;
        background: black;
    }

    .main {
        flex-direction: column;
        height: calc(100vh - 58px);
    }

    /* IMAGE TOP - FULL WIDTH */
    .left-panel {
        width: 100% !important;
        height: 55vh !important;
    }

    #xrayImage {
        max-width: 100% !important;
        max-height: 100% !important;
        object-fit: contain !important;
    }

    /* REPORT EDIT BOTTOM */
    .right-panel {
        width: 100% !important;
        height: 45vh !important;
        padding: 10px;
        overflow-y: auto;
    }

    /* Zoom bar reposition */
    .zoom-bar {
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 12px;
    }

    .zoom-btn {
        font-size: 18px;
    }
}

/* ---------- FULLSCREEN MOBILE FIX ---------- */
@media (max-width: 900px) {
    .fullscreen {
        width: 100vw !important;
        height: 100vh !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        background: black !important;
        z-index: 99999 !important;
    }

    .fullscreen img {
        width: 100vw !important;
        height: 100vh !important;
        object-fit: contain !important;
    }

    .zoom-bar {
        bottom: 20px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
    }
}
.tab-item {
    padding: 3px 8px;
    font-size: 12px;
    background: #d7e9ff;
    border-radius: 6px;
    border: 1px solid #bcd4f5;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
}

.tab-active {
    background: #1d6ede !important;
    color: white !important;
    border-color: #1055b6 !important;
}


</style>
</head>

<body>
<!-- ðŸ”µ REPORT PAGE TAB BAR -->
<div id="patientTabs" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 20px;
    background: white;
    border-bottom: 1px solid #c7d7e8;
    padding: 4px 10px;
    display: flex;
    gap: 6px;
    align-items: center;
    z-index: 9999;
">

    <!-- PERMANENT PATIENT LIST TAB -->
    <div class="tab-item" onclick="window.location.href='/index/'">
        PATIENT LIST
    </div>

</div>


<!-- ---------------- TOP HEADER ---------------- -->
<div class="top-bar">
    <span class="top-item">PAT. ID:</span> <span class="top-value">{{ patient.patient_id }}</span>
    <span class="top-item">NAME:</span> <span class="top-value">{{ patient.name }}</span>
    <span class="top-item">AGE/SEX:</span> <span class="top-value">{{ patient.age }}/{{ patient.gender }}</span>
    <span class="top-item">SCAN:</span> <span class="top-value">{{ patient.scan_type }}</span>
    <span class="top-item">BP:</span> <span class="top-value">{{ patient.body_part }}</span>
    <span class="top-item">HISTORY:</span> <span class="top-value">{{ patient.history }}</span>
</div>


<!-- ---------------- MAIN AREA ---------------- -->
<div class="main">

    <!-- LEFT IMAGE -->
    <div class="left-panel" id="leftPanel">

        <img id="xrayImage" style="background:black;" src="data:image/jpeg;base64,{{ patient.scan_image }}">


        <!-- Zoom Controls -->
        <div class="zoom-bar">
            <i class="fas fa-search-minus zoom-btn" id="zoomOut"></i>
            <i class="fas fa-search-plus zoom-btn" id="zoomIn"></i>
            <i class="fas fa-sync zoom-btn" id="reset"></i>
            <i class="fas fa-expand zoom-btn" id="fullscreen"></i>
        </div>
    </div>

    <!-- RIGHT REPORT EDITOR -->
    <div class="right-panel">
        <textarea id="editor">{{ patient.report|default_if_none:"" }}</textarea>

        <div class="btn-row">
            <button class="btn-draft" onclick="updateStatus('DRAFT')">DRAFT</button>
            <button class="btn-submit" onclick="updateStatus('FINAL')">SUBMIT</button>
        </div>
    </div>

</div>

<script>
CKEDITOR.replace("editor");

// Cropper
let image = document.getElementById("xrayImage");
let cropper = new Cropper(image, {
    viewMode: 2,
    dragMode: "move",
    autoCrop: false,
});

document.getElementById("zoomIn").onclick = () => cropper.zoom(0.2);
document.getElementById("zoomOut").onclick = () => cropper.zoom(-0.2);
document.getElementById("reset").onclick = () => cropper.reset();

document.getElementById("fullscreen").onclick = () => {
    const panel = document.getElementById("leftPanel");
    panel.classList.toggle("fullscreen");

    cropper.destroy();

    cropper = new Cropper(image, {
        viewMode: 0,
        dragMode: "move",
        autoCrop: false,
        background: false,
        responsive: true,
        zoomOnTouch: true,
        zoomOnWheel: true,
        minCanvasWidth: window.innerWidth,
        minCanvasHeight: window.innerHeight
    });
};


// Save status
function updateStatus(status){
    const report = CKEDITOR.instances.editor.getData();

    fetch(`/api/patient/{{ patient.id }}/update/`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
        body: JSON.stringify({ report, status })
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === "success"){
            alert("Updated Successfully");
            if(status === "FINAL") window.location.href="/index/";
        }
    });
}

function getCookie(name){
    let cookieValue = null;
    if(document.cookie){
        const cookies = document.cookie.split(";");
        for(const c of cookies){
            const cookie = c.trim();
            if(cookie.startsWith(name + "=")){
                cookieValue = cookie.split("=")[1];
            }
        }
    }
    return cookieValue;
}
// ---------------------------
// FULL PACS VIEWER CONTROLS
// ---------------------------

// Function to toggle fullscreen
function toggleFullscreen() {
    const panel = document.getElementById("leftPanel");

    panel.classList.toggle("fullscreen");

    cropper.destroy();
    cropper = new Cropper(image, {
        viewMode: 0,
        dragMode: "move",
        autoCrop: false,
        background: false,
        responsive: true,
        zoomOnWheel: true,
        zoomOnTouch: true,
    });
}

// ESC key â†’ exit fullscreen
document.addEventListener("keydown", function (event) {
    const panel = document.getElementById("leftPanel");

    if (event.key === "Escape" && panel.classList.contains("fullscreen")) {
        toggleFullscreen();
    }
});

// F key â†’ toggle fullscreen
document.addEventListener("keydown", function (event) {
    if (event.key.toLowerCase() === "f") {
        toggleFullscreen();
    }
});

// Double-click â†’ toggle fullscreen
image.addEventListener("dblclick", function () {
    toggleFullscreen();
});

// Arrow keys â†’ Move (PAN)
document.addEventListener("keydown", function (event) {
    if (!cropper) return;

    const step = 50; // px movement

    switch (event.key) {
        case "ArrowUp":
            cropper.move(0, step);
            break;
        case "ArrowDown":
            cropper.move(0, -step);
            break;
        case "ArrowLeft":
            cropper.move(step, 0);
            break;
        case "ArrowRight":
            cropper.move(-step, 0);
            break;
    }
});

// + key â†’ Zoom In
document.addEventListener("keydown", function (event) {
    if (event.key === "+") {
        cropper.zoom(0.2);
    }
});

// - key â†’ Zoom Out
document.addEventListener("keydown", function (event) {
    if (event.key === "-") {
        cropper.zoom(-0.2);
    }
});
function addTab(patientId, patientName) {
    let bar = document.getElementById("patientTabs");

    // Active tab ID
    let activeId = "{{ patient.id }}";

    // Avoid duplicate tab
    if (document.getElementById("tab-" + patientId)) return;

    let tab = document.createElement("div");
    tab.id = "tab-" + patientId;
    tab.classList.add("tab-item");

    // If this tab is CURRENT open patient â†’ make it active BLUE
    if (parseInt(activeId) === parseInt(patientId)) {
        tab.classList.add("tab-active");
    }

    tab.innerHTML = `
        <span>${patientName}</span>
        <b style="cursor:pointer;"
           onclick="event.stopPropagation(); this.parentElement.remove();">Ã—</b>
    `;

    tab.onclick = function () {
        window.location.href = "/report/" + patientId + "/";
    };

    bar.appendChild(tab);
}

</script>

</body>
</html>
