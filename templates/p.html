<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Add Patient</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

<style>
    body {
        margin: 0;
        padding: 25px;
        font-family: "Inter", sans-serif;
        background: #eef1f6;
    }

    .card {
        max-width: 480px;
        margin: auto;
        background: white;
        padding: 25px 30px;
        border-radius: 14px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    }

    h3 {
        text-align: center;
        margin: 0 0 20px;
        font-size: 22px;
        font-weight: 700;
        color: #1f2d3d;
    }

    /* 2 Columns */
    .row {
        display: flex;
        gap: 14px;
        margin-bottom: 16px;
    }

    .col {
        flex: 1;
    }

    label {
        display: block;
        margin-bottom: 4px;
        font-size: 13px;
        font-weight: 600;
        color: #4b5563;
    }

    .input-box {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dce1e8;
        border-radius: 10px;
        font-size: 14px;
        background: #f9fafb;
        transition: 0.2s;
    }

    .input-box:focus {
        background: #fff;
        border-color: #4a90e2;
        box-shadow: 0 0 0 2px rgba(74,144,226,0.15);
        outline: none;
    }

    /* Gender Buttons */
    .gender-group {
        display: flex;
        gap: 10px;
    }

    .gender-btn {
        flex: 1;
        padding: 10px;
        text-align: center;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: 0.2s;
    }

    .gender-btn.active {
        background: #4a90e2;
        color: white;
        border-color: #4a90e2;
        box-shadow: 0 3px 8px rgba(74,144,226,0.25);
    }

    /* Upload Box */
    .upload-box {
        border: 2px dashed #cbd5e1;
        padding: 20px;
        text-align: center;
        border-radius: 12px;
        font-size: 14px;
        cursor: pointer;
        color: #64748b;
        background: #f8fafc;
        transition: 0.2s;
        position: relative;
        margin-top: 5px;
    }

    .upload-box:hover {
        border-color: #4a90e2;
        background: #f0f7ff;
    }

    .upload-box input {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
    }

    #previewBox {
        margin-top: 12px;
        display: none;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }

    .submit-btn {
        width: 100%;
        background: #4a90e2;
        border: none;
        padding: 12px;
        color: white;
        font-size: 15px;
        border-radius: 10px;
        margin-top: 10px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 4px 14px rgba(74,144,226,0.25);
        transition: 0.25s;
    }

    .submit-btn:hover {
        background: #3a7acf;
    }

    /* Crop Modal */
    #editor {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        display: none;
        padding: 30px;
        z-index: 9999;
    }

    .editor-box {
        background: white;
        padding: 18px;
        border-radius: 12px;
        max-width: 380px;
        margin: auto;
    }

    .editor-actions {
        display: flex;
        gap: 10px;
        margin-top: 12px;
    }

    .editor-btn {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }

    .cancel { background: #e5e7eb; }
    .done { background: #4a90e2; color: white; }

</style>
</head>

<body>

<div class="card">
    <h3>Add Patient</h3>

    <form id="patientForm">

        <div class="row">
            <div class="col">
                <label>Patient ID</label>
                <input id="patientId" class="input-box" placeholder="Auto generate">
            </div>
            <div class="col">
                <label>Age</label>
                <input id="age" type="number" class="input-box" required>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>Name</label>
                <input id="patientName" class="input-box" required>
            </div>
            <div class="col">
                <label>Gender</label>
                <div class="gender-group">
                    <button type="button" class="gender-btn" data-gender="M">M</button>
                    <button type="button" class="gender-btn" data-gender="F">F</button>
                </div>
                <input type="hidden" id="gender">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>Modality</label>
                <select id="scanType" class="input-box">
                    <option>X-RAY</option>
                    <option>CT</option>
                    <option>MRI</option>
                    <option>MG</option>
                </select>
            </div>

            <div class="col">
                <label>Body Part</label>
                <input id="bodyPart" class="input-box" required>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>History</label>
                <input id="history" class="input-box" required>
            </div>

            <div class="col">
                <label>Referred By</label>
                <input id="refBy" class="input-box" required>
            </div>
        </div>

        <label>Scan Upload</label>
        <div class="upload-box">
            Click to upload scan
            <input type="file" id="uploadScan" accept="image/*">
        </div>

        <div id="previewBox">
            <img id="preview" style="width:100%;">
        </div>

        <input type="hidden" id="centerName" value="{{ request.session.user_name }}">
        <img id="finalImage" style="display:none">

        <button class="submit-btn">Submit</button>
    </form>

</div>

<!-- Cropper Editor -->
<div id="editor">
    <div class="editor-box">
        <img id="image">
        <div class="editor-actions">
            <button class="editor-btn cancel" onclick="editor.style.display='none'">Cancel</button>
            <button class="editor-btn done" onclick="done()">Done</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
// SAME JS CODE (no functionality change)

let cropper;
uploadScan.onchange = () => {
    let file = uploadScan.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = e => {
        image.src = e.target.result;
        editor.style.display = "block";

        cropper && cropper.destroy();
        cropper = new Cropper(image, { autoCropArea: 1 });
    };
    reader.readAsDataURL(file);
};

function done() {
    const canvas = cropper.getCroppedCanvas();
    const data = canvas.toDataURL("image/jpeg", 0.75);
    finalImage.src = data;
    preview.src = data;
    previewBox.style.display = "block";
    editor.style.display = "none";
}

document.querySelectorAll(".gender-btn").forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll(".gender-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        gender.value = btn.dataset.gender;
    };
});

function genID() {
    let d = new Date();
    return "P" + d.getFullYear() + (d.getMonth()+1) + d.getDate() + "-" + Math.floor(1000 + Math.random()*9000);
}

function getCookie(name){
    let value = null;
    document.cookie.split(";").forEach(c=>{
        c=c.trim();
        if(c.startsWith(name+"=")) value = c.substring(name.length+1);
    });
    return value;
}

patientForm.onsubmit = e => {
    e.preventDefault();

    let pid = patientId.value.trim();
    if (pid === "") pid = genID();

    let data = {
        patient_id: pid,
        name: patientName.value,
        age: age.value,
        gender: gender.value,
        history: history.value,
        scanType: scanType.value,
        bodyPart: bodyPart.value,
        refBy: refBy.value,
        scan: finalImage.src,
        center: centerName.value
    };

    fetch("/api/patient/add/", {
        method: "POST",
        headers: { "Content-Type":"application/json", "X-CSRFToken": getCookie("csrftoken") },
        body: JSON.stringify(data)
    }).then(r=>r.json()).then(res=>{
        if(res.status === "success") location.href="/imagingA/";
        else alert(res.message);
    });
};
</script>

</body>
</html>
