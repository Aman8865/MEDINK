<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User List</title>

    <!-- Bootstrap CSS & JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background-color: #f4f6f9; padding: 25px; }
        .table-responsive { max-height: 600px; overflow-y: auto; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .card { border-radius: 10px; }
        .modal-content { border-radius: 15px; }
    </style>
</head>
<body>

<h2 class="mb-4">üë• All Users Management</h2>

{% if messages %}
  {% for msg in messages %}
    <div class="alert alert-{{ msg.tags }} alert-dismissible fade show" role="alert">
      {{ msg }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<div class="card shadow-sm">
  <div class="card-header bg-dark text-white">
    <h5 class="mb-0">Users List</h5>
  </div>
  <div class="card-body">
    <div class="mb-3">
      <input type="text" id="searchUser" class="form-control" placeholder="üîç Search by Name, User ID, or Type...">
    </div>

    <div class="table-responsive">
      <table class="table table-hover table-bordered" id="usersTable">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>User ID</th>
            <th>User Type</th>
            <th>Status</th>
            <th>Created At</th>
            <th>Parent Admin</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr ondblclick="openAdminDetails({{ user.id }})">

            <td>{{ forloop.counter }}</td>
            <td>{{ user.name }}</td>
            <td>{{ user.userid }}</td>
            <td>
              <span class="badge
                {% if user.usertype == 'ADMIN' %}bg-primary
                {% elif user.usertype == 'IMAGING' %}bg-success
                {% elif user.usertype == 'RADS' %}bg-info
                {% else %}bg-secondary{% endif %}">
                {{ user.usertype }}
              </span>
            </td>
            <td>
              <span class="badge {% if user.is_active %}bg-success{% else %}bg-danger{% endif %}">
                {% if user.is_active %}Active{% else %}Inactive{% endif %}
              </span>
            </td>
            <td>{{ user.created_at|date:"d M Y, h:i A" }}</td>
            <td>
              {% if user.parent_admin %}{{ user.parent_admin.name }}{% else %}<span class="text-muted">-</span>{% endif %}
            </td>
            <td>
              <button class="btn btn-sm btn-info" onclick="viewUser({{ user.id }})">üëÅÔ∏è</button>
              <button class="btn btn-sm btn-warning" onclick="editUser({{ user.id }})">‚úèÔ∏è</button>
              <button class="btn btn-sm {% if user.is_active %}btn-secondary{% else %}btn-success{% endif %}" onclick="toggleStatus({{ user.id }})">
                {% if user.is_active %}üîí{% else %}üîì{% endif %}
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteUser({{ user.id }}, '{{ user.name }}')">üóëÔ∏è</button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted">No users found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- View Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">View User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Name:</strong> <span id="view_name"></span></p>
        <p><strong>User ID:</strong> <span id="view_userid"></span></p>
        <p><strong>Type:</strong> <span id="view_usertype"></span></p>
        <p><strong>Status:</strong> <span id="view_status"></span></p>
        <p><strong>Created At:</strong> <span id="view_created_at"></span></p>
        <p><strong>Parent Admin:</strong> <span id="view_parent_admin"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editUserForm" method="POST">
          {% csrf_token %}
          <input type="hidden" id="edit_user_id" name="user_id">
          <div class="mb-2"><label>Name</label><input type="text" class="form-control" id="edit_name" name="name"></div>
          <div class="mb-2"><label>User ID</label><input type="text" class="form-control" id="edit_userid" name="userid"></div>
          <div class="mb-2">
            <label>Type</label>
            <select class="form-select" id="edit_usertype" name="usertype">
              <option value="ADMIN">ADMIN</option>
              <option value="IMAGING">IMAGING</option>
              <option value="RADS">RADS</option>
            </select>
          </div>
          <div class="mb-2">
            <label>Status</label>
            <select class="form-select" id="edit_is_active" name="is_active">
              <option value="1">Active</option>
              <option value="0">Inactive</option>
            </select>
          </div>
          <div class="mb-2" id="edit_adminSelectContainer" style="display:none;">
            <label>Parent Admin</label>
            <select class="form-select" id="edit_parent_admin_id" name="parent_admin_id">
              {% for admin in admins %}
              <option value="{{ admin.id }}">{{ admin.name }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function openAdminDetails(adminId){
    window.location.href = `/admin-details/${adminId}/`;

}

document.addEventListener('DOMContentLoaded', function() {
    const editAdminSelectContainer = document.getElementById('edit_adminSelectContainer');
    const editUsertypeSelect = document.getElementById('edit_usertype');

    // Show/hide parent admin on change
    if(editUsertypeSelect){
        editUsertypeSelect.addEventListener('change', function(){
            editAdminSelectContainer.style.display = (this.value==='IMAGING' || this.value==='RADS') ? 'block':'none';
        });
    }

    // Search
    document.getElementById('searchUser').addEventListener('input', function(){
        const filter = this.value.toLowerCase();
        document.querySelectorAll('#usersTable tbody tr').forEach(row=>{
            row.style.display = row.textContent.toLowerCase().includes(filter)?'':'none';
        });
    });
});

// View user modal
function viewUser(userId){
    fetch(`/user-details/${userId}/`).then(res=>res.json()).then(data=>{
        document.getElementById('view_name').textContent = data.name;
        document.getElementById('view_userid').textContent = data.userid;
        document.getElementById('view_usertype').innerHTML = `<span class="badge bg-primary">${data.usertype}</span>`;
        document.getElementById('view_status').innerHTML = `<span class="badge ${data.is_active?'bg-success':'bg-danger'}">${data.is_active?'Active':'Inactive'}</span>`;
        document.getElementById('view_created_at').textContent = data.created_at;
        document.getElementById('view_parent_admin').textContent = data.parent_admin || '-';
        new bootstrap.Modal(document.getElementById('viewUserModal')).show();
    }).catch(err=>{console.error(err); alert('Failed to load user details');});
}

// Edit user modal
function editUser(userId){
    const editAdminSelectContainer = document.getElementById('edit_adminSelectContainer');
    fetch(`/user-details/${userId}/`).then(res=>res.json()).then(data=>{
        document.getElementById('edit_user_id').value = userId;
        document.getElementById('edit_name').value = data.name;
        document.getElementById('edit_userid').value = data.userid;
        document.getElementById('edit_usertype').value = data.usertype;
        document.getElementById('edit_is_active').value = data.is_active?'1':'0';
        document.getElementById('edit_parent_admin_id').value = data.parent_admin_id || '';
        editAdminSelectContainer.style.display = (data.usertype==='IMAGING'||data.usertype==='RADS')?'block':'none';
        document.getElementById('editUserForm').action = `/update-user/${userId}/`;
        new bootstrap.Modal(document.getElementById('editUserModal')).show();
    }).catch(err=>{console.error(err); alert('Failed to load user details');});
}

// Toggle Status
function toggleStatus(userId){ if(confirm('Are you sure?')) window.location.href=`/user/toggle/${userId}/`; }

// Delete
function deleteUser(userId,userName){ if(confirm(`Delete ${userName}?`)) window.location.href=`/delete-user/${userId}/`; }
</script>

</body>
</html>
