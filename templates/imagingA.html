
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.3.0/docx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>



    <style>
/* ðŸŒ GLOBAL STYLE */
body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    font-family: Arial, sans-serif;
    background-color: #f8f9fa;
}

/* ðŸ§­ TOP NAVBAR */
.top-navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background-color: #d6eefe;
    color: #0d47a1;
    display: flex;
    align-items: center;
    padding: 0 15px;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.top-navbar img {
    border-radius: 50%;
}

.top-navbar span {
    font-weight: bold;
    margin-left: 15px;
    font-size: 1.1rem;
}

/* Toggle Button */
.toggle-btn {
    position: fixed;
    top: 500px;
    left: 10px;
    background-color: rgb(190, 190, 193);
    color: black;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 5px;
    z-index: 1000;
    transition: left 0.3s;
}

/* ðŸ§­ SECOND NAVBAR (Filters) */
.nav2 {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    padding: 10px;
    margin-top: 60px;
    margin-left: 0px;
    transition: margin-left 0.3s ease;
    background-color: white;
    border-bottom: 1px solid #cfd8dc;
    color: #0d47a1;
}

.nav2 button,
.nav2 a {
    padding: 6px 10px;
    font-size: 12px;
    font-weight: 500;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.nav2 button.active-filter {
    background-color: #007bff;
    color: white;
}

.nav2 .date-filter {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* ðŸ“‹ TABLE SECTION */
.nav3 {
    margin-left: 0px;
    overflow-x: auto;
    background-color: white;
    transition: margin-left 0.3s ease;
}

.nav3 table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.nav3 th,
.nav3 td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.nav3 th {
    background-color: #f0f0f0;
    font-weight: bold;
}

/* ðŸŸ¢ STATUS COLORS */
.status {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.status.unread { background-color: #ffebee; color: red; }
.status.draft { background-color: #fff3e0; color: orange; }
.status.final { background-color: #e8f5e9; color: green; }

.green-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: green;
    border-radius: 50%;
}

/* ðŸ“± RESPONSIVE DESIGN */

/* TABLE + FILTERS FOR TABLETS */
@media (max-width: 992px) {
    .nav2 {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
    }
    .nav3 {
        margin-left: 0px;
        width: 100%;
    }
}

/* TABLE + FILTERS FOR MOBILE */
@media (max-width: 768px) {
    .top-navbar span {
        font-size: 1rem;
    }

    .nav2 {
        flex-direction: column;
        gap: 10px;
        align-items: stretch !important;
    }

    .nav2 > * {
        width: 100% !important;
    }

    #searchInput {
        width: 100% !important;
        padding: 8px 40px 8px 12px !important;
        font-size: 12px;
    }

    .nav2 i.fa-search {
        right: 12px !important;
    }

    .nav3 table {
        font-size: 11px;
        min-width: 850px;
    }

    .nav3 th,
    .nav3 td {
        padding: 6px;
    }
}

/* MOBILE SMALL SCREEN FIX */
@media (max-width: 480px) {
    .top-navbar {
        justify-content: space-between;
        padding: 0 10px;
    }

    .top-navbar span {
        display: none;
    }

    .nav2 {
        padding: 8px;
        margin-left: 0;
    }

    .nav3 {
        margin-left: 0;
    }

    th:nth-child(6), td:nth-child(6),
    th:nth-child(9), td:nth-child(9) {
        display: none;
    }

    td strong,
    td small {
        font-size: 11px;
    }

    td {
        padding: 4px !important;
    }

    #statusFilter span {
        font-size: 12px;
        padding: 4px;
    }
}

/* TABLE SCROLL & STICKY HEADER */
#nav3 {
    max-height: 450px;
    overflow-y: auto;
    border: 1px solid #ddd;
}

#nav3 thead th {
    position: sticky;
    top: 0;
    background-color: rgb(230, 228, 228);
    z-index: 10;
    border-bottom: 2px solid #ccc;
}

/* ROW COLORS */
tr {
    background-color: #f7fbff !important;
}

tr:hover {
    background-color: #eef6ff !important;
}

tr.status-final { background-color: #f2fbf2 !important; }
tr.status-unread { background-color: #fff4f4 !important; }
tr.status-draft { background-color: #fef9e7 !important; }

.status-option.active {
    font-weight: 700 !important;
    color:  #007bff !important;
}

/* ======= MOBILE UI BEAUTIFICATION ======= */
@media (max-width: 480px) {

    body {
        background: #eef3f8;
        padding: 0 6px;
    }

    /* Top section & Add New button */
    #nav2 {
        background: white;
        border-radius: 10px;
        padding: 12px;
        gap: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        width: 100%;
    }

    /* Add New button full width */
    #nav2 button:first-child {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        font-size: 14px;
    }

    /* Search box styling */
    #searchInput {
        width: 100% !important;
        padding: 10px 40px 10px 12px !important;
        border-radius: 8px !important;
        border: 1px solid #ccc !important;
        background: #fafafa;
        font-size: 14px;
    }
    .nav2 i.fa-search {
        right: 15px !important;
    }

    /* Status filter bar */
    #statusFilter {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        background: #fafafa;
        text-align: center;
        
    }

    #statusFilter span {
        padding: 4px 6px;
        border-radius: 4px;
    }

    /* Scan filter chip bar */
    .nav2 button:nth-child(4) {
        width: 100%;
        border-radius: 8px;
        padding: 8px;
        background: #eef6ff !important;
        border: 1px solid #c8defd !important;
    }

    /* Date Filter button full width */
    .date-filter button {
        width: 100%;
        border-radius: 8px;
        padding: 8px;
        background: #eef6ff;
        border: 1px solid #c8defd;
    }

    /* TABLE container card */
    #nav3 {
        margin-top: 12px;
        background: white;
        border-radius: 10px;
        padding: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        width: 100%;
    }

    table {
        min-width: 750px; /* prevents squeezing */
    }

    td strong {
        font-size: 13px;
    }
    td small {
        font-size: 11px;
    }

    /* Extra clean spacing */
    .nav2 > * {
        margin-bottom: 5px;
    }
}

.add-btn {
    background: #007bff;  
    width: 100px;         /* blue */
    color: white;
    font-weight: 600;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;            /* smooth rounded */
    font-size: 15px;
    display: inline-flex;
    align-items: center;
    gap: 6px;                      /* icon gap */
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
    transition: 0.25s ease-in-out; /* smooth animation */
}

.add-btn:hover {
    background: #0056d2;           /* darker blue on hover */
    box-shadow: 0 6px 12px rgba(0, 123, 255, 0.45);
    transform: translateY(-2px);   /* small lift effect */
}

.add-btn:active {
    transform: scale(0.96);        /* click animation */
}

/* Date range */
.date-chip-box {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #ffffff;
    border: 1px solid rgb(217, 217, 217);
    /* padding: 8px 10px; */
    border-radius: 5px;
    font-size: 12px;
    font-weight: 500;
}

.chip {
    cursor: pointer;
    padding: 0 6px;
    color: #1f1f20;
    font-weight: 500;
}

.chip.active {
    color: #007bff;
    font-weight: 500;
    font-weight: 600;
}

.divider {
    color: #b0b0b0;
}

.calendar-icon {
    padding: 4px 6px;
    cursor: pointer;
    background: #ffffff;
    border-radius: 6px;
    /* border: 1px solid #c9dfff; */
}

.calendar-icon i {
    color: #007bff;
    font-size: 14px;
}
#dayChip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 60px;       /* FIXED WIDTH */
    height: 26px;
    padding: 0 !important;
    text-align: center;
}


    </style>
</head>
<body>
<div class="top-navbar">
    <img height="40" style="border-radius: 30px;" src="data:image/png;base64,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" alt="Profile">
    
    <span >HOSPITAL</span>
    {% if request.session.user_name %}
       <span style="margin-left: 900px; font-size: 13px; margin-top: 30px;">Welcome, {{ request.session.user_name }}</span>
       <a href="{% url 'logout' %}" style="text-decoration:none; margin-top: 30px; margin-left: 10px; color:red;">
          <i class="fas fa-sign-out-alt"></i> 
      </a>

    {% endif %}

</div>
{% block body %}

<div id="nav2"  class="nav2">
    <button style="font-weight: 600;" class="add-btn" onclick="window.location.href='/popupform/'">
    <i class="fas fa-user-plus"></i> Add New
</button>


<div class="date-chip-box" style="box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);">

    <!-- <span class="chip active" style="color: #007bff;" onclick="setDateFilter('ALL')">All</span> -->
    <!-- <span class="divider">|</span> -->

    <span style="color:#007bff ; font-weight: bold;" class="chip" onclick="goPrevDay()">&lt;&lt;</span>

    <span id="dayChip" class="chip active" onclick="setDateFilter('TODAY')">TODAY</span>


    <span style="color:#007bff; font-weight: bold;" class="chip" onclick="goNextDay()">&gt;&gt;</span>

    <!-- <span class="divider">|</span> -->
    <span class="chip" onclick="setDateFilter('MONTH')">MONTH</span>

    <span class="calendar-icon" onclick="openDateRange()">
        <i class="fa-regular fa-calendar"></i>
    </span>
</div>

<div id="statusFilter" style="padding: 6px; box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); gap background-color: white; border-radius: 5px; font-size:12px; font-weight: 500; margin-left: 0px; border: 1px solid #ccc; margin-top: 0px; ">
    <span id="filter-all" class="status-option" style="cursor:pointer; padding: 0 6px;color: #007bff; font-weight: 600;" onclick="filterPatients('ALL')">All</span><span style="color: black;"> |</span>
    <span id="filter-final" class="status-option" style="cursor:pointer; padding: 0 6px; color: black;" onclick="filterPatients('FINAL')">FINAL</span><span style="color: black;"> |</span>
    <span id="filter-unread" class="status-option" style="cursor:pointer; padding: 0 6px; color: black;" onclick="filterPatients('UNREAD')">UNREAD</span>

</div>
     <button style="padding: 6px; background-color: white; font-size:12px;box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); font-weight: 500;border: 1px solid #ccc; margin-left: 0px; margin-top: 0px;">
       <span style="color: #007bff; font-weight: 600; cursor:pointer; font-weight: 600;" onclick="filterByScanType('ALL')">All</span> | 
       <span style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('X-RAY')">X-RAY</span> | 
       <span style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('CT')">CT</span> | 
       <span style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('MRI')">MRI</span> | 
       <span style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('MG')">MG</span>
    </button>

 <div style=" display: inline-block; margin-left: 4px;box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); position: relative;">
  <input type="search" id="searchInput" placeholder="search scan..."
    style="margin-left: 0px;border: 1px solid #ccc; color: rgb(232, 230, 230); padding: 3px 35px 5px 10px; border-radius: 5px; font-weight: 400;  width: 150px; font-size: 14px;">

</div>
    <a href="" style="background-color: rgb(251, 250, 250);box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); border: 1px solid #ccc; color: #007bff;">
        <i class="fa-solid fa-search"></i>
    </a>
    <a href="" style="background-color: rgb(251, 250, 250);box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); border: 1px solid #ccc; color: #007bff;">
        <i class="fa-solid fa-rotate-right"></i>
    </a>

<div id="calendarContainer" style="display:none; margin-left: -700px; margin-top:15px; position:relative;">
    <div id="calendarBox" style="position:absolute; z-index:9999; background:white; padding:10px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15);">
        
        <input type="text" id="calendarInput" readonly 
               style="width:240px; padding:8px; border:1px solid #ccc; border-radius:6px; display: none;">

        <div id="litepickerInline" style="margin-top:8px;"></div>
    </div>
</div>
</div>   <!-- Close nav2 properly -->

<div id="nav3" class="nav3">
    <table >
        <thead>
            <tr>
                 <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">Date</th>
                <th>Patient</th>
                <th>Age/Sex</th>
                <th>Scan Type</th>
                <th>Body Part</th>
                <th>History</th>
                <!-- <th>Assign</th> -->
                <th>Report</th>
                <th>Status</th>
                <th>Amount</th>
                <!-- <th>Action</th> -->
            </tr>
            
        </thead>
        
        
        <tbody  id="patientTable">
            
            {% for patient in patients %}
            <tr onclick="window.location.href='/report/{{patient.id}}/'" 
    style="cursor:pointer; background-color: {% if patient.status == 'FINAL' %}#e8f5e9{% elif patient.status == 'DRAFT' %}#fff3e0{% else %}#ffebee{% endif %}">

                <td>
                    
                    <input type="checkbox" class="rowCheckbox" data-id="{{patient.id}}" onclick="event.stopPropagation()">

                    <br>
                    <small>{{patient.entry_time|date:"d/m/Y"}} | {{patient.entry_time|time:"H:i"}}</small>
                </td>
                <td>
                    <strong>{{patient.name}}</strong><br>
                    <small>{{patient.patient_id}}</small>
                </td>
                <td>{{patient.age}}/{{patient.gender}}</td>
                <td>{{patient.scan_type}}</td>
                <td>
                    <strong>{{patient.body_part|upper}}</strong><br>
                    <small>{{patient.ref_by}}</small>
                </td>
                <td>{{patient.history}}</td>
                <!-- <td>
                    Dr. {{patient.ref_by}}<br>
                    <small>{{patient.entry_time|date:"d/m/Y"}}</small>
                </td> -->
                <td>
                    <i class="fa-regular fa-file-pdf" style="color:red; cursor:pointer; margin-right:8px;" 
                       onclick="downloadReport({{patient.id}}, 'pdf', event)"></i>
                    <i class="fa-regular fa-file-word" style="color:blue; cursor:pointer;" 
                       onclick="downloadReport({{patient.id}}, 'word', event)"></i>
                    <span class="status {{patient.status|lower}}">{{patient.status}}</span>
                </td>
                <td><span class="green-dot"></span></td>
                <td>â‚¹100</td>
                <!-- <td>
                    <i class="fa-solid fa-trash" style="color:red; cursor:pointer;" 
                       onclick="deletePatient(event, {{patient.id}})"></i>
                </td> -->
                
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
</div>

{% endblock %}



<script>

// filteration
let currentStatusFilter = 'ALL';
let currentScanFilter = 'ALL';

function filterPatients(status) {
    currentStatusFilter = status.toUpperCase();
    applyFilters();

    // Active button highlight
    const buttons = document.querySelectorAll('.nav2 button');
    buttons.forEach(btn => btn.classList.remove('active-filter'));
    const activeBtn = [...buttons].find(btn => btn.textContent.trim().toUpperCase().includes(status));
    if (activeBtn) activeBtn.classList.add('active-filter');
}

function filterByScanType(scanType) {
    currentScanFilter = scanType.toUpperCase();
    applyFilters();

    // Active button highlight for scan type spans
    const btnSpans = document.querySelectorAll('.nav2 span');
    btnSpans.forEach(span => span.style.fontWeight = '');
    if(scanType !== 'ALL') {
        const activeSpan = [...btnSpans].find(s => s.textContent.trim().toUpperCase() === scanType.toUpperCase());
        if(activeSpan) activeSpan.style.fontWeight = '600';
    } else {
        const allSpan = [...btnSpans].find(s => s.textContent.trim().toUpperCase() === 'ALL');
        if(allSpan) allSpan.style.fontWeight = '600';
    }
}


// Add these functions to your existing script section

function downloadReport(id, type, event) {
    event.stopPropagation();
    fetch(`/api/patient/${id}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(patient => {
            console.log('Patient data:', patient); // For debugging
            if(patient.status !== 'FINAL') {
                alert('Report can only be downloaded for finalized reports');
                return;
            }
            
            if(type === 'pdf') {
                generatePDF(patient);
            } else if(type === 'word') {
                generateWord(patient);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error downloading report');
        });
}

function generatePDF(patient) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add logo or header
    doc.setFontSize(20);
    doc.text('MEDINK REPORT', 105, 20, { align: 'center' });
    
    // Add patient details
    doc.setFontSize(12);
    doc.text('PATIENT DETAILS', 20, 40);
    doc.setFontSize(10);
    doc.text(`Patient ID: ${patient.patient_id}`, 20, 50);
    doc.text(`Name: ${patient.name}`, 20, 60);
    doc.text(`Age/Gender: ${patient.age}/${patient.gender}`, 20, 70);
    doc.text(`Scan Type: ${patient.scan_type}`, 20, 80);
    doc.text(`Body Part: ${patient.body_part}`, 20, 90);
    doc.text(`Referred By: Dr. ${patient.ref_by}`, 20, 100);
    
    // Add report content
    doc.setFontSize(12);
    doc.text('REPORT', 20, 120);
    doc.setFontSize(10);
    
    const reportText = patient.report || 'No report available';
    const splitReport = doc.splitTextToSize(reportText, 170);
    doc.text(splitReport, 20, 130);
    
    doc.save(`MEDINK_Report_${patient.patient_id}.pdf`);
}

function generateWord(patient) {
    const { Document, Paragraph, TextRun, HeadingLevel, Packer } = docx;
    
    const doc = new Document({
        sections: [{
            properties: {},
            children: [
                new Paragraph({
                    text: "MEDINK REPORT",
                    heading: HeadingLevel.HEADING_1,
                    alignment: docx.AlignmentType.CENTER
                }),
                new Paragraph({
                    text: "PATIENT DETAILS",
                    heading: HeadingLevel.HEADING_2
                }),
                new Paragraph({
                    children: [new TextRun(`Patient ID: ${patient.patient_id}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Name: ${patient.name}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Age/Gender: ${patient.age}/${patient.gender}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Scan Type: ${patient.scan_type}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Body Part: ${patient.body_part}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Referred By: Dr. ${patient.ref_by}`)]
                }),
                new Paragraph({
                    text: "REPORT",
                    heading: HeadingLevel.HEADING_2
                }),
                new Paragraph({
                    children: [new TextRun(patient.report || 'No report available')]
                })
            ]
        }]
    });

    Packer.toBlob(doc).then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `MEDINK_Report_${patient.patient_id}.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    });
}

function exportSelectedToExcel() {
    const selectedCheckboxes = document.querySelectorAll('.rowCheckbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select at least one patient to export');
        return;
    }

    const data = [];
    const headers = ['Patient ID', 'Name', 'Age/Gender', 'Scan Type', 'Body Part', 'History', 'Referred By', 'Status'];
    
    selectedCheckboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const rowData = {
            'Patient ID': row.querySelector('td:nth-child(2) small').textContent,
            'Name': row.querySelector('td:nth-child(2) strong').textContent,
            'Age/Gender': row.querySelector('td:nth-child(3)').textContent,
            'Scan Type': row.querySelector('td:nth-child(4)').textContent,
            'Body Part': row.querySelector('td:nth-child(5) strong').textContent,
            'History': row.querySelector('td:nth-child(6)').textContent,
            'Referred By': row.querySelector('td:nth-child(7)').textContent,
            'Status': row.querySelector('.status').textContent
        };
        data.push(rowData);
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Patients");
    XLSX.writeFile(wb, "selected_patients.xlsx");
}

function toggleSelectAll(checkbox) {
    const rowCheckboxes = document.querySelectorAll('.rowCheckbox');
    rowCheckboxes.forEach(cb => cb.checked = checkbox.checked);
}

// datae range
let selectedDateFilter = "TODAY";
let tempSelectedDay = dateOnly(new Date());

function dateOnly(d) {
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function setDateFilter(type) {
    selectedDateFilter = type;

    document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
    const chip = [...document.querySelectorAll(".chip")]
        .find(x => x.textContent.toUpperCase().includes(type));
    if (chip) chip.classList.add("active");

    if (type === "TODAY") {
        tempSelectedDay = dateOnly(new Date());
    }

    applyFilters();
}

function goPrevDay() {
    tempSelectedDay = dateOnly(new Date());
    tempSelectedDay.setDate(tempSelectedDay.getDate() - 1);

    selectedDateFilter = "DAY-JUMP";

    // UI Update
    document.getElementById("dayChip").textContent = "YESTERDAY";

    // Remove active from all chips
    document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));

    applyFilters();
}



function goNextDay() {
    tempSelectedDay = dateOnly(new Date());
    selectedDateFilter = "TODAY";

    // UI Update
    document.getElementById("dayChip").textContent = "TODAY";

    // Remove active and set TODAY active
    document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
    document.getElementById("dayChip").classList.add("active");

    applyFilters();
}
window.onload = function() {
    document.getElementById("dayChip").classList.add("active");
    selectedDateFilter = "TODAY";
    tempSelectedDay = dateOnly(new Date());
    applyFilters();
};

 





// ðŸŸ¢ SEARCH + FILTER COMBINED
// SEARCH + FILTER (FINAL WORKING VERSION)
const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("keyup", applyFilters);
function applyFilters() {
    const rows = document.querySelectorAll("#patientTable tr");
    const searchText = searchInput.value.trim().toUpperCase();

    rows.forEach(row => {

        /* STATUS FILTER */
        const status = row.querySelector(".status")?.textContent.trim().toUpperCase();
        const statusMatch = currentStatusFilter === "ALL" || status === currentStatusFilter;

        /* SCAN FILTER */
        const scanType = row.querySelector("td:nth-child(4)")?.textContent.trim().toUpperCase();
        const scanMatch = currentScanFilter === "ALL" || scanType === currentScanFilter;

        /* SEARCH FILTER */
        const name = row.querySelector("td:nth-child(2) strong")?.textContent.trim().toUpperCase();
        const pid = row.querySelector("td:nth-child(2) small")?.textContent.trim().toUpperCase();
        const searchMatch = searchText === "" || name.includes(searchText) || pid.includes(searchText);

        /* DATE FILTER */
        let dateMatch = true;
        const dateText = row.querySelector("td small")?.textContent.split(" | ")[0];

        if (dateText) {
            const [d,m,y] = dateText.split("/");
            const entryDate = dateOnly(new Date(`${y}-${m}-${d}`));

            const today = dateOnly(new Date());
            const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);  
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            if (selectedDateFilter === "TODAY")
                dateMatch = (entryDate.getTime() === today.getTime());

            // if (selectedDateFilter === "YESTERDAY")
            //     dateMatch = (entryDate.getTime() === yesterday.getTime());

            if (selectedDateFilter === "DAY-JUMP")
                dateMatch = (entryDate.getTime() === tempSelectedDay.getTime());

            if (selectedDateFilter === "MONTH")
                dateMatch = (entryDate >= monthStart && entryDate <= monthEnd);

           if (selectedDateFilter === "RANGE" && startDate && endDate) {
                const s = dateOnly(startDate);
                const e = dateOnly(endDate);
                dateMatch = (entryDate >= s && entryDate <= e);
            }


        }

        /* FINAL SHOW/HIDE */
        row.style.display = (statusMatch && scanMatch && searchMatch && dateMatch) ? "" : "none";
    });
}

function filterPatients(status) {
    currentStatusFilter = status.toUpperCase();
    applyFilters();

    // Remove active from all
    document.querySelectorAll(".status-option").forEach(x => {
        x.classList.remove("active");
    });

    // Add active to clicked
    document.getElementById(`filter-${status.toLowerCase()}`).classList.add("active");
}



function openDateRange() {
    const box = document.getElementById("calendarContainer");
    box.style.display = (box.style.display === "none" || box.style.display === "") ? "block" : "none";
}
function closeCalendar() {
    document.getElementById("calendarContainer").style.display = "none";
}

let selectedStart = null;
let selectedEnd = null;

const picker = new Litepicker({
    element: document.getElementById('calendarInput'),
    inlineMode: true,
    container: document.getElementById('litepickerInline'),
    singleMode: false,
    numberOfMonths: 1,
    numberOfColumns: 1,
    format: 'YYYY-MM-DD',
    autoApply: true, // autoApply off because we'll manually apply when both dates selected
    setup: (pickerInstance) => {
        pickerInstance.on('selected', (start, end) => {
            // start or end are Luxon-like objects from Litepicker; get native Date:
            selectedStart = start ? start.dateInstance : null;
            selectedEnd = end ? end.dateInstance : null;

            if (selectedStart && selectedEnd) {
                // update visible input (optional)
                document.getElementById('calendarInput').value =
                    pickerInstance.getStartDate('YYYY-MM-DD') + " â†’ " +
                    pickerInstance.getEndDate('YYYY-MM-DD');

                // set global range vars used by applyFilters()
                startDate = selectedStart;
                endDate = selectedEnd;
                selectedDateFilter = "RANGE";

                // close the calendar UI
                closeCalendar();

                // apply filters immediately
                applyFilters();
            }
        });

        // optional: if user clears selection, reset variables
        pickerInstance.on('clear', () => {
            selectedStart = null;
            selectedEnd = null;
            startDate = null;
            endDate = null;
            selectedDateFilter = "ALL";
            document.getElementById('calendarInput').value = '';
            applyFilters();
        });
    }
});


function applyDateRange() {
    if (!selectedStart || !selectedEnd) {
        alert("Please select a valid range.");
        return;
    }

    startDate = selectedStart;
    endDate = selectedEnd;
    selectedDateFilter = "RANGE";

    closeCalendar();
    applyFilters();
}

</script>
</body>
</html>