
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.3.0/docx.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>



    <style>
       /* üåê GLOBAL STYLE */
body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    font-family: Arial, sans-serif;
    background-color: #f8f9fa;
}

/* üß≠ TOP NAVBAR */
.top-navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background-color: rgb(176, 176, 243);
    display: flex;
    align-items: center;
    padding: 0 15px;
    color: black;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.top-navbar img {
    border-radius: 50%;
}

.top-navbar span {
    font-weight: bold;
    margin-left: 15px;
    font-size: 1.1rem;
}

/* üìë SIDEBAR */
.sidebar2 {
    position: fixed;
    top: 60px;
    left: 0;
    height: 100%;
    width: 60px;
    background-color: rgb(182, 182, 245);
    transition: width 0.3s ease;
    overflow-x: hidden;
    z-index: 999;
}

.sidebar2:hover {
    width: 130px;
}

.sidebar2 a {
    display: flex;
    align-items: center;
    color: white;
    padding: 12px;
    text-decoration: none;
    font-size: 18px;
    white-space: nowrap;
    transition: background-color 0.3s ease;
}

.sidebar2 a:hover {
    background-color: white;
    border-radius: 30px;
    color: black;
}

.sidebar2 a i {
    min-width: 40px;
    text-align: center;
    color: black;
}

.sidebar2 a span {
    opacity: 0;
    transform: translateX(-10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    color: gray;
}

.sidebar2:hover a span {
    opacity: 1;
    transform: translateX(0);
}
/* üîÑ Hide Sidebar when toggled */
.sidebar-hidden {
    width: 0 !important;
    overflow: hidden;
}



/* Toggle Button */
.toggle-btn {
    position: fixed;
    top: 500px;
    left: 10px;
    background-color: rgb(190, 190, 193);
    color: black;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 5px;
    z-index: 1000;
    transition: left 0.3s;
}
/* ‚úÖ Make nav2 fixed just below top navbar */
.nav2 {
    position: absolute;
    top: 60px; /* top navbar height */
    left: 60px; /* sidebar width */
    right: 0;
    background-color: #606160;
    color: white;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    padding: 10px;
    z-index: 900;
    height: auto;
    transition: left 0.3s ease;
}

/* ‚úÖ nav3 (table area) scrollable */
.nav3 {
    position: absolute;
    top: 120px; /* nav2 height (approx 60px + 60px = 120px from top) */
    left: 60px;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    background-color: white;
    transition: left 0.3s ease;
    padding-bottom: 50px;
}

/* ‚úÖ Scrollbar style (optional) */
.nav3::-webkit-scrollbar {
    width: 8px;
}
.nav3::-webkit-scrollbar-thumb {
    background-color: #ccc;
    border-radius: 4px;
}

/* ‚úÖ When sidebar hidden */
.sidebar-hidden ~ .nav2 {
    left: 0 !important;
}
.sidebar-hidden ~ .nav3 {
    left: 0 !important;
}

/* üì± Responsive adjustment */
@media (max-width: 768px) {
    .nav2 {
        left: 55px;
    }
    .nav3 {
        left: 55px;
        top: 130px;
    }
}
@media (max-width: 480px) {
    .nav2 {
        left: 0;
        top: 60px;
    }
    .nav3 {
        left: 0;
        top: 120px;
    }
}

/* ‚úÖ Body should not scroll */
body {
    overflow: hidden;
}



.nav2 button, .nav2 a {
    padding: 6px 10px;
    font-size: 12px;
    font-weight: 500;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.nav2 button.active-filter {
    background-color: #007bff;
    color: white;
}

.nav2 .date-filter {
    display: flex;
    align-items: center;
    gap: 5px;
}



.nav3 table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.nav3 th, .nav3 td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.nav3 th {
    background-color: #f0f0f0;
    font-weight: bold;
}

/* üü¢ STATUS COLORS */
.status {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.status.unread { background-color: #ffebee; color: red; }
.status.draft { background-color: #fff3e0; color: orange; }
.status.final { background-color: #e8f5e9; color: green; }

.green-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: green;
    border-radius: 50%;
}

/* üì± RESPONSIVE DESIGN */
@media (max-width: 992px) {
    .sidebar2 {
        width: 55px;
    }
    .nav2 {
        margin-left: 55px;
        flex-direction: column;
        align-items: flex-start;
    }
    .nav3 {
        margin-left: 55px;
    }
}

@media (max-width: 768px) {
    .top-navbar span {
        font-size: 1rem;
    }
    .nav2 {
        flex-direction: column;
        gap: 6px;
    }
    .nav2 button {
        width: 100%;
    }
    .nav3 table {
        font-size: 11px;
    }
    .nav3 th, .nav3 td {
        padding: 6px;
    }
    .toggle-btn {
        top: 70px;
        left: 10px;
    }
}

@media (max-width: 480px) {
    .top-navbar {
        justify-content: space-between;
        padding: 0 10px;
    }
    .top-navbar span {
        display: none;
    }
    .sidebar2 {
        width: 0;
    }
    .nav2 {
        margin-left: 0;
        padding: 8px;
    }
    .nav3 {
        margin-left: 0;
    }
    .nav3 table {
        font-size: 10px;
    }
    th:nth-child(6), td:nth-child(6),
    th:nth-child(9), td:nth-child(9) {
        display: none; /* hide extra columns on small screen */
    }
}

#refreshTimer {
  font-size: 14px;
  color: #007bff;
}

#nav3 {
  max-height: 450px;         /* scroll height adjust kar lo */
  overflow-y: auto;           /* sirf vertical scroll */
  border: 1px solid #ddd;     /* optional border */
}

#nav3 table {
  width: 100%;
  border-collapse: collapse;
}

#nav3 thead th {
  position: sticky;
  top: 0;
  background-color: rgb(153, 152, 152);    /* ya apne theme ke hisab se */
  z-index: 10;
  border-bottom: 2px solid #ccc;
}

#nav3 th, #nav3 td {
  padding: 8px 12px;
  text-align: left;
  border: 1px solid #eee;
}

#statusFilter .active {
  color: #00ffcc;
  font-weight: bold;
}


    </style>
</head>
<body>
    
    
<!-- side navbar -->
 <div class="sidebar2">
    <a href="#"><i class="fas fa-bars"></i><span></span></a>
    <a href="{% url 'index' %}"><i class="fas fa-home"></i><span>Home</span></a>
    <a href="{% url 'signup' %}"><i class="fas fa-user"></i><span>User</span></a>
    <a href="#"><i class="fas fa-cog"></i><span>Settings</span></a>
    <a href="{% url 'invoice' %}"><i class="fa-solid fa-file-invoice"></i><span>Invoice</span></a>
     <!-- üî• Sidebar Logout -->
    <a href="{% url 'logout' %}" style="margin-top:auto; border-radius:8px;">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
    </a>
  
    <!-- hise sidebar button -->
</div>

</div>
  <div class="toggle-btn" id="toggleBtn">
  <i class="fas fa-chevron-left"></i>
</div>

<div class="top-navbar">
    <img height="40" style="border-radius: 30px;" src="data:image/png;base64,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" alt="Profile">
    
    <span style="margin-left: 500px;" ></span>
    <h3>Welcome, {{ user_name }} </h3>
    <!-- üîµ Only Profile Icon on Right -->
    <div style="margin-left:auto; margin-right:20px; cursor:pointer;">
        <i class="fa-solid fa-user-circle" 
           style="font-size:30px; color:white;"></i>
    </div>

</div>

{% block body %}

<div id="nav2"  class="nav2">
    <button style="background-color: blue; color: white; font-weight: 600;" onclick="window.location.href='/popupform/'">
        <i class="fas fa-plus"></i> Add New
    </button>

   <div id="statusFilter" style="padding: 6px; background-color: white; border-radius: 5px; font-size:12px; font-weight: 500; margin-left: 0px; margin-top: 0px; ">
  <span id="filter-all" style="color: rgb(142, 142, 224); font-weight: 600; cursor:pointer;"  onclick="filterPatients('ALL')">All</span><span style="color: black;"> |</span>
  <span id="filter-final" style="cursor:pointer; color:black;" onclick="filterPatients('FINAL')">FINAL</span><span style="color: black;"> |</span>
  <span id="filter-unread" style="cursor:pointer; color:black;" onclick="filterPatients('UNREAD')">UNREAD</span>
</div>

   <select style="padding: 5px; border-radius: 4px;" id="centerSelect" name="center">
    <option value="ALL">All Imaging</option>
    {% for c in centers %}
        <option value="{{ c.name }}">{{ c.name }}</option>
    {% endfor %}
</select>
<label for="radsSelect"></label>
<select id="radsSelect" name="rads" style="padding: 5px; border-radius: 4px;">
    <option value="ALL">All Rads</option>
    {% for r in rads %}
        <option value="{{ r.name }}">{{ r.name }}</option>
    {% endfor %}
</select>

<!-- <p style="color:red;">{{ centers.count }} imaging centers found</p> -->


     <button style="padding: 6px; font-size:12px; font-weight: 500; margin-left: 0px; margin-top: 0px;">
       <span style="color: rgb(142, 142, 224); font-weight: 600; cursor:pointer;" onclick="filterByScanType('ALL')">All</span> | 
       <span style="cursor:pointer;" onclick="filterByScanType('X-RAY')">X-RAY</span> | 
       <span style="cursor:pointer;" onclick="filterByScanType('CT')">CT</span> | 
       <span style="cursor:pointer;" onclick="filterByScanType('MRI')">MRI</span> | 
       <span style="cursor:pointer;" onclick="filterByScanType('MG')">MG</span>
    </button>
<button onclick="exportSelectedToExcel()" style="background-color: #4CAF50; font-weight: 600; color: white;">
    E-xcel
</button>

    <!-- <a href="" style="background-color: aliceblue; padding: 3px; border-radius: 8px;">
        <i class="fa-solid fa-rotate-right"></i>
    </a> -->

   <div class="date-filter">
  <button id="dateFilterBtn"><i class="fas fa-calendar"></i>Date</button>

  <input id="dateRangeInput" type="text" placeholder="Select date range" readonly
         style="margin-left:8px; display: none; padding:6px 10px; border-radius:4px; border:none; width:220px; font-size:14px;" />

  <div class="date-cycle">
  <button id="dateCycleBtn" style="margin-left:6px; padding:6px 10px; border-radius:5px; border:none; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:6px;">
    <i class="fas fa-arrow-left" onclick="changeDateFilter('left', event)"></i>
    <span id="dateCycleLabel">Clear</span>
    <i class="fas fa-arrow-right" onclick="changeDateFilter('right', event)"></i>
  </button>
</div>



  <div style=" display: inline-block; margin-left: 4px;">
    <input type="search" id="searchInput" placeholder="Search det..."
      style="margin-left: 0px; padding: 3px 35px 5px 10px; border-radius: 3px; border: none; width: 150px; font-size: 16px;">
  </div>
</div>


    <span id="refreshTimer" style="margin-left: 0px; font-weight: 500; color: white;">
    üîÑÔ∏è<span id="live-seconds" style="font-weight:bold; color:white;">30s</span>


</span>
<a href="" style="background-color: aliceblue; padding: 6px; margin-left: 90px; border-radius: 8px;">
        <i class="fa-solid fa-rotate-right"></i>
    </a>

</div>



<div  id="nav3" class="nav3" class="max-h-[450px] overflow-y-auto border border-gray-300">
    <table class="min-w-full border-collapse" >
         <thead class="bg-white sticky top-0 z-10 border-b-2 border-gray-200">
      <tr>
        <th class="p-2">Center/Date</th>
        <th class="p-2">Patient</th>
        <th class="p-2">Age/Sex</th>
        <th class="p-2">Scan Type</th>
        <th class="p-2">Body Part</th>
        <th class="p-2">History</th>
        <th class="p-2">Assign</th>
        <th class="p-2">Report</th>
        <!-- <th class="p-2">TAT</th> -->
        <th class="p-2">Amount</th>
      </tr>
    </thead>
        
        
        <tbody  id="patientTable">
            
            {% for patient in patients %}
            <tr data-entry-date="{{ patient.entry_time|date:'Y-m-d' }}"
            data-center="{{ patient.imaging_center.name }}" 
            onclick="window.location.href='/report/{{patient.id}}/'" 
                style="cursor:pointer; background-color: {% if patient.status == 'FINAL' %}#e8f5e9{% elif patient.status == 'DRAFT' %}#fff3e0{% else %}#ffebee{% endif %}">
                
                <td>
                    
                    <input type="checkbox" class="rowCheckbox" data-id="{{patient.id}}" onclick="event.stopPropagation()">

                    {{ patient.center }}<br>
                    <small>{{patient.entry_time|date:"d/m/Y"}} | {{patient.entry_time|time:"H:i"}}</small>
                </td>
                <td>
                    <strong>{{patient.name}}</strong><br>
                    <small>{{patient.patient_id}}</small>
                </td>
                <td>{{patient.age}}/{{patient.gender}}</td>
                <td>{{patient.scan_type}}</td>
                <td>
                    <strong>{{patient.body_part|upper}}</strong><br>
                    <small>{{patient.ref_by}}</small>
                </td>
                <td>{{patient.history}}</td>
              <td onclick="event.stopPropagation();">
    <select class="assign-dropdown" data-patient="{{ patient.id }}" onchange="assignPatient('{{patient.id}}', this.value)">
        <option value="">Select</option>
        {% for r in rads %}
            <option value="{{r.id}}" {% if patient.assigned_to and patient.assigned_to.id == r.id %}selected{% endif %}>
                {{r.name}}
            </option>
        {% endfor %}
    </select>
    <br>
    <small class="entry-time">{{patient.entry_time|date:"d/m/Y"}} | {{patient.entry_time|time:"H:i"}}</small>
    <!-- show currently assigned -->
    {% if patient.assigned_to %}
      <!-- <br><small class="assigned-to-display">{{ patient.assigned_to.name }}</small> -->
    {% else %}
      <br><small class="assigned-to-display"></small>
    {% endif %}
</td>


                <td>
                    <i class="fa-regular fa-file-pdf" style="color:red; cursor:pointer; margin-right:8px;" 
                       onclick="downloadReport({{patient.id}}, 'pdf', event)"></i>
                    <i class="fa-regular fa-file-word" style="color:blue; cursor:pointer;" 
                       onclick="downloadReport({{patient.id}}, 'word', event)"></i>
                    <span class="status {{patient.status|lower}}">{{patient.status}}</span>
                </td>
                <!-- <td><span class="green-dot"></span></td> -->
                <td>‚Çπ100</td>
                <!-- <td>
                    <i class="fa-solid fa-trash" style="color:red; cursor:pointer;" 
                       onclick="deletePatient(event, {{patient.id}})"></i>
                </td> -->
                
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
</div>

{% endblock %}



<script>
// üîπ CENTER FILTER
document.getElementById('centerSelect').addEventListener('change', function() {
    const selectedCenter = this.value.toUpperCase();
    const rows = document.querySelectorAll('#patientTable tr');

    rows.forEach(row => {
        const rowCenter = row.getAttribute('data-center')?.toUpperCase() || '';

        const statusSpan = row.querySelector('.status');
        const rowStatus = statusSpan ? statusSpan.textContent.trim().toUpperCase() : '';
        const rowScanType = row.querySelector('td:nth-child(4)').textContent.trim().toUpperCase();

        const statusMatch = (currentStatusFilter === 'ALL' || rowStatus === currentStatusFilter);
        const scanMatch = (currentScanFilter === 'ALL' || rowScanType === currentScanFilter);
        const centerMatch = (selectedCenter === 'ALL' || rowCenter === selectedCenter);

        // Final display condition
        if (statusMatch && scanMatch && centerMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});





const sidebar = document.querySelector('.sidebar2');
const toggleBtn = document.getElementById('toggleBtn');
const nav2 = document.getElementById('nav2');
const nav3 = document.getElementById('nav3');

toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('sidebar-hidden');


    const icon = toggleBtn.querySelector('i');

    if (sidebar.classList.contains('sidebar-hidden')) {
        // Sidebar hidden ‚Üí shift right
        icon.classList.remove('fa-chevron-left');
        icon.classList.add('fa-chevron-right');

        // Smooth shift
        nav2.style.marginLeft = "0px";
        nav3.style.marginLeft = "0px";

    } else {
        // Sidebar visible ‚Üí shift back
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-left');

        nav2.style.marginLeft = "0px";
        nav3.style.marginLeft = "0px";
    }
});

// filteration
let currentStatusFilter = 'ALL';
let currentScanFilter = 'ALL';

function filterPatients(status) {
    currentStatusFilter = status.toUpperCase();
    applyFilters();

    // Active button highlight
    const buttons = document.querySelectorAll('.nav2 button');
    buttons.forEach(btn => btn.classList.remove('active-filter'));
    const activeBtn = [...buttons].find(btn => btn.textContent.trim().toUpperCase().includes(status));
    if (activeBtn) activeBtn.classList.add('active-filter');
}

function filterByScanType(scanType) {
    currentScanFilter = scanType.toUpperCase();
    applyFilters();

    // Active button highlight for scan type spans
    const btnSpans = document.querySelectorAll('.nav2 span');
    btnSpans.forEach(span => span.style.fontWeight = '');
    if(scanType !== 'ALL') {
        const activeSpan = [...btnSpans].find(s => s.textContent.trim().toUpperCase() === scanType.toUpperCase());
        if(activeSpan) activeSpan.style.fontWeight = '600';
    } else {
        const allSpan = [...btnSpans].find(s => s.textContent.trim().toUpperCase() === 'ALL');
        if(allSpan) allSpan.style.fontWeight = '600';
    }
}

function applyFilters() {
    const rows = document.querySelectorAll('#patientTable tr');

    rows.forEach(row => {
        const statusSpan = row.querySelector('.status');
        const rowStatus = statusSpan ? statusSpan.textContent.trim().toUpperCase() : '';
        const rowScanType = row.querySelector('td:nth-child(4)').textContent.trim().toUpperCase();

        const statusMatch = (currentStatusFilter === 'ALL' || rowStatus === currentStatusFilter);
        const scanMatch = (currentScanFilter === 'ALL' || rowScanType === currentScanFilter);

        if (statusMatch && scanMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Add these functions to your existing script section

function downloadReport(id, type, event) {
    event.stopPropagation();
    fetch(`/api/patient/${id}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(patient => {
            console.log('Patient data:', patient); // For debugging
            if(patient.status !== 'FINAL') {
                alert('Report can only be downloaded for finalized reports');
                return;
            }
            
            if(type === 'pdf') {
                generatePDF(patient);
            } else if(type === 'word') {
                generateWord(patient);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error downloading report');
        });
}

function generatePDF(patient) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add logo or header
    doc.setFontSize(20);
    doc.text('MEDINK REPORT', 105, 20, { align: 'center' });
    
    // Add patient details
    doc.setFontSize(12);
    doc.text('PATIENT DETAILS', 20, 40);
    doc.setFontSize(10);
    doc.text(`Patient ID: ${patient.patient_id}`, 20, 50);
    doc.text(`Name: ${patient.name}`, 20, 60);
    doc.text(`Age/Gender: ${patient.age}/${patient.gender}`, 20, 70);
    doc.text(`Scan Type: ${patient.scan_type}`, 20, 80);
    doc.text(`Body Part: ${patient.body_part}`, 20, 90);
    doc.text(`Referred By: Dr. ${patient.ref_by}`, 20, 100);
    
    // Add report content
    doc.setFontSize(12);
    doc.text('REPORT', 20, 120);
    doc.setFontSize(10);
    
    const reportText = patient.report || 'No report available';
    const splitReport = doc.splitTextToSize(reportText, 170);
    doc.text(splitReport, 20, 130);
    
    doc.save(`MEDINK_Report_${patient.patient_id}.pdf`);
}

function generateWord(patient) {
    const { Document, Paragraph, TextRun, HeadingLevel, Packer } = docx;
    
    const doc = new Document({
        sections: [{
            properties: {},
            children: [
                new Paragraph({
                    text: "MEDINK REPORT",
                    heading: HeadingLevel.HEADING_1,
                    alignment: docx.AlignmentType.CENTER
                }),
                new Paragraph({
                    text: "PATIENT DETAILS",
                    heading: HeadingLevel.HEADING_2
                }),
                new Paragraph({
                    children: [new TextRun(`Patient ID: ${patient.patient_id}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Name: ${patient.name}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Age/Gender: ${patient.age}/${patient.gender}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Scan Type: ${patient.scan_type}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Body Part: ${patient.body_part}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Referred By: Dr. ${patient.ref_by}`)]
                }),
                new Paragraph({
                    text: "REPORT",
                    heading: HeadingLevel.HEADING_2
                }),
                new Paragraph({
                    children: [new TextRun(patient.report || 'No report available')]
                })
            ]
        }]
    });

    Packer.toBlob(doc).then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `MEDINK_Report_${patient.patient_id}.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    });
}

function exportSelectedToExcel() {
    const selectedCheckboxes = document.querySelectorAll('.rowCheckbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select at least one patient to export');
        return;
    }

    const data = [];
    const headers = ['Patient ID', 'Name', 'Age/Gender', 'Scan Type', 'Body Part', 'History', 'Referred By', 'Status'];
    
    selectedCheckboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const rowData = {
            'Patient ID': row.querySelector('td:nth-child(2) small').textContent,
            'Name': row.querySelector('td:nth-child(2) strong').textContent,
            'Age/Gender': row.querySelector('td:nth-child(3)').textContent,
            'Scan Type': row.querySelector('td:nth-child(4)').textContent,
            'Body Part': row.querySelector('td:nth-child(5) strong').textContent,
            'History': row.querySelector('td:nth-child(6)').textContent,
            'Referred By': row.querySelector('td:nth-child(7)').textContent,
            'Status': row.querySelector('.status').textContent
        };
        data.push(rowData);
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Patients");
    XLSX.writeFile(wb, "selected_patients.xlsx");
}

function toggleSelectAll(checkbox) {
    const rowCheckboxes = document.querySelectorAll('.rowCheckbox');
    rowCheckboxes.forEach(cb => cb.checked = checkbox.checked);
}


// üü¢ SEARCH + FILTER COMBINED
const searchInput = document.getElementById('searchInput');
searchInput.addEventListener('keyup', applyFilters);

function applyFilters() {
    const rows = document.querySelectorAll('#patientTable tr');
    const searchText = document.getElementById('searchInput').value.trim().toUpperCase();

    rows.forEach(row => {
        const statusSpan = row.querySelector('.status');
        const rowStatus = statusSpan ? statusSpan.textContent.trim().toUpperCase() : '';
        const rowScanType = row.querySelector('td:nth-child(4)').textContent.trim().toUpperCase();

        const nameCell = row.querySelector('td:nth-child(2) strong');
        const idCell = row.querySelector('td:nth-child(2) small');
        const nameText = nameCell ? nameCell.textContent.trim().toUpperCase() : '';
        const idText = idCell ? idCell.textContent.trim().toUpperCase() : '';

        // Existing filters (status + scan)
        const statusMatch = (currentStatusFilter === 'ALL' || rowStatus === currentStatusFilter);
        const scanMatch = (currentScanFilter === 'ALL' || rowScanType === currentScanFilter);

        // New search match (name + patient ID)
        const searchMatch = (
            searchText === '' || 
            nameText.includes(searchText) || 
            idText.includes(searchText)
        );

        // Final combined check
        if (statusMatch && scanMatch && searchMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// function deletePatient(event, id) {
//     event.stopPropagation(); // row click se bachne ke liye

//     if (!confirm("Are you sure you want to delete this entry?")) return;

//     fetch(`/delete_patient/${id}/`, {
//         method: "DELETE",
//         headers: {
//             "X-CSRFToken": getCookie("csrftoken"), // Django CSRF token
//         },
//     })
//     .then(response => {
//         if (response.ok) {
//             alert("Patient entry deleted successfully!");
//             event.target.closest("tr").remove(); // table row hata do
//         } else {
//             alert("Failed to delete entry!");
//         }
//     })
//     .catch(error => {
//         console.error("Error:", error);
//         alert("Something went wrong!");
//     });
// }

// Django ke liye CSRF token getter
// function getCookie(name) {
//     let cookieValue = null;
//     if (document.cookie && document.cookie !== "") {
//         const cookies = document.cookie.split(";");
//         for (let i = 0; i < cookies.length; i++) {
//             const cookie = cookies[i].trim();
//             if (cookie.substring(0, name.length + 1) === name + "=") {
//                 cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
//                 break;
//             }
//         }
//     }
//     return cookieValue;
// }
const centerSelect = document.getElementById("centerSelect");
centerSelect.addEventListener("change", function() {
    const selectedCenter = this.value.toUpperCase();
    const rows = document.querySelectorAll("#patientTable tbody tr");

    rows.forEach(row => {
        const center = row.getAttribute("data-center")?.toUpperCase() || '';
        if (selectedCenter === "ALL" || center === selectedCenter) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
});

document.getElementById('radsSelect').addEventListener('change', function() {
    const selectedRad = this.value.toUpperCase();
    const rows = document.querySelectorAll('#patientTable tr');

    rows.forEach(row => {
        const rowRad = row.querySelector('td:nth-child(7)')?.textContent.trim().toUpperCase() || '';
        const rowStatus = row.querySelector('.status')?.textContent.trim().toUpperCase() || '';
        const rowScanType = row.querySelector('td:nth-child(4)').textContent.trim().toUpperCase();

        const statusMatch = (currentStatusFilter === 'ALL' || rowStatus === currentStatusFilter);
        const scanMatch = (currentScanFilter === 'ALL' || rowScanType === currentScanFilter);
        const radMatch = (selectedRad === 'ALL' || rowRad.includes(selectedRad));

        if (statusMatch && scanMatch && radMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// all RADS assign-dropdown
function assignPatient(patientId, radId) {
    if (!radId) return; // nothing selected

    fetch(`/assign_patient/${patientId}/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ rad_id: radId })
    })
    .then(response => {
        if (response.ok) {
            alert("Patient assigned successfully!");
        } else {
            alert("Failed to assign patient!");
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error assigning patient!");
    });
}



function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// function assignPatient(patientId, radId) {
//     // radId can be empty string for unassign
//     fetch(`/assign_patient/${patientId}/`, {
//         method: "POST",
//         headers: {
//             "Content-Type": "application/json",
//             // If you removed @csrf_exempt above, uncomment CSRF header:
//             "X-CSRFToken": getCookie("csrftoken")
//         },
//         body: JSON.stringify({ rad_id: radId })
//     })
//     .then(res => res.json())
//     .then(data => {
//         if (data.success) {
//             // Update UI: show assigned name below the dropdown
//             const dropdown = document.querySelector(`select.assign-dropdown[data-patient="${patientId}"]`);
//             if (dropdown) {
//                 // find/create assigned display element
//                 let small = dropdown.parentElement.querySelector('.assigned-to-display');
//                 if (!small) {
//                     small = document.createElement('small');
//                     small.className = 'assigned-to-display';
//                     dropdown.parentElement.appendChild(document.createElement('br'));
//                     dropdown.parentElement.appendChild(small);
//                 }
//                 small.textContent = data.assigned_to ? data.assigned_to.name : '';
//             }
//             alert("Assigned successfully‚úÖ");
//         } else {
//             alert("Assign failed: " + (data.error || 'Unknown'));
//         }
//     })
//     .catch(err => {
//         console.error(err);
//         alert("Error assigning");
//     });
// }

// ‚úÖ Auto-refresh countdown + refresh
document.addEventListener("DOMContentLoaded", function() {
    let countdown = 30; // 30 seconds timer
    const timerDisplay = document.getElementById("live-seconds");

   function updateTimer() {
        if (!timerDisplay) return;

        // Change color based on remaining seconds
        if (countdown > 10) {
            timerDisplay.style.color = "white"; // normal
        } else if (countdown > 5) {
            timerDisplay.style.color = "orange"; // warning
        } else {
            timerDisplay.style.color = "red"; // danger
        }

        timerDisplay.textContent = countdown + "s";
        countdown--;

        if (countdown < 0) {
            countdown = 30; // reset timer
            refreshTbody(); // refresh tbody data
        }
    }

    // tbody refresh function
    function refreshTbody() {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const newTbody = doc.querySelector("tbody");
                const oldTbody = document.querySelector("tbody");

                if (newTbody && oldTbody) {
                    oldTbody.innerHTML = newTbody.innerHTML;
                }
            })
            .catch(err => console.error("Error refreshing tbody:", err));
    }

    // timer update every 1 second
    setInterval(updateTimer, 1000);
});


// date range filter
 function ymdToNumber(ymd) {
    if (!ymd) return null;
    var parts = ymd.split('-');
    return Number(parts[0] + parts[1].padStart(2,'0') + parts[2].padStart(2,'0'));
  }

  document.addEventListener('DOMContentLoaded', function() {
    const dateRangeInput = document.getElementById('dateRangeInput');
    const dateFilterBtn = document.getElementById('dateFilterBtn');
    const clearDateBtn = document.getElementById('clearDateBtn');

    const picker = new Litepicker({
      element: dateRangeInput,
      singleMode: false,
      numberOfMonths: 2,
      numberOfColumns: 2,
      format: 'YYYY-MM-DD',
      setup: (picker) => {
        picker.on('selected', (start, end) => {
          dateRangeInput.value = start.format('YYYY-MM-DD') + ' ‚Äî ' + end.format('YYYY-MM-DD');
          applyDateFilter(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
        });
      }
    });

    dateFilterBtn.addEventListener('click', e => {
      e.preventDefault();
      picker.show();
    });

    dateRangeInput.addEventListener('click', () => picker.show());

    clearDateBtn.addEventListener('click', () => {
      dateRangeInput.value = '';
      applyDateFilter(null, null);
    });
  });

  function applyDateFilter(startYmd, endYmd) {
    const rows = document.querySelectorAll('#patientTable tr');
    const startNum = startYmd ? ymdToNumber(startYmd) : null;
    const endNum   = endYmd   ? ymdToNumber(endYmd)   : null;

    rows.forEach(row => {
      const rowYmd = row.getAttribute('data-entry-date');
      const rowNum = rowYmd ? ymdToNumber(rowYmd) : null;

      let show = true;
      if (startNum && endNum && rowNum) {
        show = (rowNum >= startNum && rowNum <= endNum);
      }
      row.style.display = show ? '' : 'none';
    });
  }

  function filterByDate(type) {
    const rows = document.querySelectorAll('#patientTable tr');
    const today = new Date();
    let targetDate = new Date(today);

    // Determine target date
    if (type === 'yesterday') {
        targetDate.setDate(today.getDate() - 1);
    }

    // Format date in YYYY-MM-DD (same as data-entry-date attribute)
    const targetDateStr = targetDate.toISOString().split('T')[0];

    // Filter rows
    rows.forEach(row => {
        const entryDate = row.getAttribute('data-entry-date');
        if (type === 'today' || type === 'yesterday') {
            if (entryDate === targetDateStr) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        } else {
            // show all if type is 'all'
            row.style.display = '';
        }
    });

    // Highlight active filter button (optional)
    document.querySelectorAll('.nav2 button').forEach(btn => btn.classList.remove('active-filter'));
    const activeBtn = [...document.querySelectorAll('.nav2 button')].find(b => b.textContent.trim().toLowerCase() === type);
    if (activeBtn) activeBtn.classList.add('active-filter');
}

  // Available filter options
  const dateOptions = ["Clear", "Today", "Yesterday"];
  let currentIndex = 0; // start with Clear

  function changeDateFilter(direction, event) {
    // Stop button click bubbling
    event.stopPropagation();

    if (direction === "right") {
      currentIndex = (currentIndex + 1) % dateOptions.length;
    } else if (direction === "left") {
      currentIndex = (currentIndex - 1 + dateOptions.length) % dateOptions.length;
    }

    // Update label text
    const label = document.getElementById("dateCycleLabel");
    label.textContent = dateOptions[currentIndex];

    // Apply corresponding filter
    const selected = dateOptions[currentIndex].toLowerCase();
    if (selected === "clear") {
      applyDateFilter(null, null); // clear all date filters
    } else {
      filterByDate(selected); // use your existing function
    }
  }


function filterPatients(status) {
  currentStatusFilter = status.toUpperCase();
  applyFilters();

  // Highlight selected filter
  document.querySelectorAll('#statusFilter span').forEach(el => el.classList.remove('active'));
  const activeEl = document.querySelector(`#filter-${status.toLowerCase()}`);
  if (activeEl) activeEl.classList.add('active');
}

</script>
</body>
</html>